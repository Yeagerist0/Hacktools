#!/bin/bash

#====================================================================
#  HACKSTRIKE OLLAMA - AI-Powered Bug Bounty CLI
#  Uses local Ollama LLM for intelligent command processing
#====================================================================

set -o pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
VERSION="1.0"
TARGET=""
MODEL="${OLLAMA_MODEL:-llama3.2}"
OLLAMA_URL="${OLLAMA_URL:-http://localhost:11434}"
CONTEXT_FILE="$SCRIPT_DIR/.ollama_context"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
GRAY='\033[0;90m'
NC='\033[0m'
BOLD='\033[1m'

banner() {
    clear
    echo -e "${RED}"
    cat << "BANNER"
    ?????????  ????????? ??????????????????  ??????????????????????????????  ????????????????????????????????????????????????????????????????????????????????? ??????????????????  ?????????????????????????????????
    ?????????  ?????????????????????????????????????????????????????????????????? ????????????????????????????????????????????????????????????????????????????????????????????????????????? ????????????????????????????????????
    ?????????????????????????????????????????????????????????     ????????????????????? ????????????????????????   ?????????   ?????????????????????????????????????????????????????? ??????????????????  
    ?????????????????????????????????????????????????????????     ????????????????????? ????????????????????????   ?????????   ?????????????????????????????????????????????????????? ??????????????????  
    ?????????  ??????????????????  ??????????????????????????????????????????  ?????????????????????????????????   ?????????   ?????????  ???????????????????????????  ?????????????????????????????????
    ?????????  ??????????????????  ????????? ??????????????????????????????  ?????????????????????????????????   ?????????   ?????????  ???????????????????????????  ?????????????????????????????????
BANNER
    echo -e "${NC}"
    echo -e "${CYAN}?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????${NC}"
    echo -e "  ${WHITE}${BOLD}AI-Powered Bug Bounty Assistant${NC}  ${GRAY}v${VERSION}${NC}  ${GREEN}Powered by Ollama${NC}"
    echo -e "${CYAN}?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????${NC}"
    echo ""
}

log() { echo -e "${GREEN}[+]${NC} $1"; }
warn() { echo -e "${YELLOW}[!]${NC} $1"; }
error() { echo -e "${RED}[-]${NC} $1"; }
info() { echo -e "${BLUE}[*]${NC} $1"; }
ai_say() { echo -e "${PURPLE}???? AI:${NC} $1"; }

# Check if Ollama is running
check_ollama() {
    if ! curl -s "$OLLAMA_URL/api/tags" &>/dev/null; then
        warn "Ollama is not running. Starting Ollama..."
        ollama serve &>/dev/null &
        sleep 3
    fi
    
    # Check if model exists
    if ! ollama list 2>/dev/null | grep -q "$MODEL"; then
        warn "Model '$MODEL' not found. Pulling..."
        ollama pull "$MODEL"
    fi
}

# Query Ollama
ask_ollama() {
    local prompt="$1"
    local system_prompt="You are HackStrike AI, a bug bounty hunting assistant. You help users with security testing.
Current target: ${TARGET:-not set}
Available commands you can suggest:
- scan <target>: Run vulnerability scan
- recon <target>: Reconnaissance
- subdomains: Find subdomains
- urls: Collect URLs
- nuclei: Run nuclei scanner
- xss: Test for XSS
- sqli: Test for SQL injection
- ports: Port scan
- secrets: Find exposed secrets
- results: Show results

When user asks to scan or test something, output the exact command they should run.
Be concise and helpful. Focus on bug bounty hunting."

    local response=$(curl -s "$OLLAMA_URL/api/generate" \
        -H "Content-Type: application/json" \
        -d "{
            \"model\": \"$MODEL\",
            \"prompt\": \"$prompt\",
            \"system\": \"$system_prompt\",
            \"stream\": false,
            \"options\": {
                \"temperature\": 0.7,
                \"num_predict\": 500
            }
        }" 2>/dev/null | jq -r '.response // empty' 2>/dev/null)
    
    if [[ -z "$response" ]]; then
        echo "I couldn't process that. Try a direct command like 'scan example.com' or 'help'"
    else
        echo "$response"
    fi
}

# Extract command from AI response or user input
extract_command() {
    local input="$1"
    local lower=$(echo "$input" | tr '[:upper:]' '[:lower:]')
    
    # Direct commands
    if [[ "$lower" =~ ^(scan|recon|subdomains|urls|probe|nuclei|xss|sqli|ports|secrets|results|vulns|tools|help|exit|quit|clear|target) ]]; then
        echo "$input"
        return 0
    fi
    
    # Natural language patterns
    case "$lower" in
        *"find subdomains"*|*"enumerate subdomains"*|*"subdomain"*)
            echo "subdomains"
            ;;
        *"find vulnerabilities"*|*"vulnerability scan"*|*"vuln"*)
            echo "scan vulns"
            ;;
        *"find xss"*|*"test xss"*|*"cross site"*)
            echo "xss"
            ;;
        *"find sql"*|*"sql injection"*|*"sqli"*)
            echo "sqli"
            ;;
        *"port scan"*|*"scan ports"*|*"open ports"*)
            echo "ports"
            ;;
        *"find secrets"*|*"exposed"*|*"leak"*)
            echo "secrets"
            ;;
        *"collect url"*|*"find url"*|*"wayback"*)
            echo "urls"
            ;;
        *"full scan"*|*"scan everything"*|*"complete scan"*)
            echo "scan full"
            ;;
        *"recon"*|*"reconnaissance"*)
            echo "scan recon"
            ;;
        *"show result"*|*"what did you find"*|*"findings"*)
            echo "results"
            ;;
        *"check tools"*|*"installed tools"*)
            echo "tools"
            ;;
        *"exit"*|*"quit"*|*"bye"*)
            echo "exit"
            ;;
        *"help"*|*"what can you do"*|*"commands"*)
            echo "help"
            ;;
        *)
            # Check for domain in input
            local domain=$(echo "$input" | grep -oE '[a-zA-Z0-9][-a-zA-Z0-9]*\.[a-zA-Z]{2,}(\.[a-zA-Z]{2,})?' | head -1)
            if [[ -n "$domain" ]]; then
                if [[ "$lower" =~ (scan|test|hack|attack|check) ]]; then
                    echo "scan $domain"
                else
                    echo "target $domain"
                fi
            else
                echo ""
            fi
            ;;
    esac
}

# Execute command
run_command() {
    local cmd="$1"
    local args=$(echo "$cmd" | cut -d' ' -f2-)
    local action=$(echo "$cmd" | awk '{print $1}')
    
    case "$action" in
        target)
            if [[ -n "$args" && "$args" != "$action" ]]; then
                TARGET=$(echo "$args" | sed 's|https\?://||' | sed 's|/.*||')
                log "Target set: ${CYAN}$TARGET${NC}"
            else
                [[ -n "$TARGET" ]] && info "Current target: ${CYAN}$TARGET${NC}" || warn "No target set"
            fi
            ;;
        scan)
            if [[ -z "$TARGET" ]]; then
                # Check if target is in args
                local t=$(echo "$args" | grep -oE '[a-zA-Z0-9][-a-zA-Z0-9]*\.[a-zA-Z]{2,}' | head -1)
                [[ -n "$t" ]] && TARGET="$t"
            fi
            
            if [[ -z "$TARGET" ]]; then
                error "No target set. Use: target <domain>"
                return
            fi
            
            local mode=$(echo "$args" | grep -oE '(full|recon|vulns|ports|xss|sqli)' | head -1)
            mode="${mode:-full}"
            
            log "Starting $mode scan on ${CYAN}$TARGET${NC}..."
            "$SCRIPT_DIR/hackstrike" "$TARGET" "--$mode"
            ;;
        subdomains|subs)
            [[ -z "$TARGET" ]] && { error "No target set"; return; }
            log "Finding subdomains for ${CYAN}$TARGET${NC}..."
            subfinder -d "$TARGET" -silent 2>/dev/null | tee "$SCRIPT_DIR/results/${TARGET}_subs.txt"
            ;;
        urls)
            [[ -z "$TARGET" ]] && { error "No target set"; return; }
            log "Collecting URLs for ${CYAN}$TARGET${NC}..."
            echo "$TARGET" | gau --threads 5 2>/dev/null | tee "$SCRIPT_DIR/results/${TARGET}_urls.txt"
            ;;
        probe)
            [[ -z "$TARGET" ]] && { error "No target set"; return; }
            log "Probing ${CYAN}$TARGET${NC}..."
            echo "$TARGET" | httpx -silent -status-code -title -tech-detect
            ;;
        nuclei)
            [[ -z "$TARGET" ]] && { error "No target set"; return; }
            log "Running nuclei on ${CYAN}$TARGET${NC}..."
            echo "https://$TARGET" | nuclei -severity critical,high,medium -silent
            ;;
        xss)
            [[ -z "$TARGET" ]] && { error "No target set"; return; }
            log "Testing XSS on ${CYAN}$TARGET${NC}..."
            "$SCRIPT_DIR/hackstrike" "$TARGET" --xss
            ;;
        sqli)
            [[ -z "$TARGET" ]] && { error "No target set"; return; }
            log "Testing SQLi on ${CYAN}$TARGET${NC}..."
            "$SCRIPT_DIR/hackstrike" "$TARGET" --sqli
            ;;
        ports)
            [[ -z "$TARGET" ]] && { error "No target set"; return; }
            log "Scanning ports on ${CYAN}$TARGET${NC}..."
            "$SCRIPT_DIR/hackstrike" "$TARGET" --ports
            ;;
        secrets)
            [[ -z "$TARGET" ]] && { error "No target set"; return; }
            log "Hunting secrets on ${CYAN}$TARGET${NC}..."
            for path in ".git/HEAD" ".env" ".git/config" "wp-config.php.bak" ".htaccess"; do
                local code=$(curl -sk --max-time 3 -o /dev/null -w "%{http_code}" "https://$TARGET/$path")
                [[ "$code" == "200" ]] && echo -e "${RED}[FOUND]${NC} https://$TARGET/$path"
            done
            ;;
        results)
            local latest=$(ls -td "$SCRIPT_DIR/results"/*/ 2>/dev/null | head -1)
            [[ -n "$latest" ]] && cat "$latest/reports/report.md" 2>/dev/null || warn "No results found"
            ;;
        vulns)
            local latest=$(ls -td "$SCRIPT_DIR/results"/*/ 2>/dev/null | head -1)
            [[ -f "$latest/vulns/nuclei.txt" ]] && cat "$latest/vulns/nuclei.txt" || warn "No vulnerabilities found"
            ;;
        tools)
            info "Installed tools:"
            for t in subfinder httpx nuclei nmap ffuf dalfox sqlmap gau; do
                command -v "$t" &>/dev/null && echo -e "  ${GREEN}???${NC} $t" || echo -e "  ${RED}???${NC} $t"
            done
            ;;
        clear)
            banner
            ;;
        help)
            echo -e "${WHITE}${BOLD}Commands:${NC}"
            echo -e "  ${GREEN}target${NC} <domain>    Set target"
            echo -e "  ${GREEN}scan${NC} [mode]       Scan target (full/recon/vulns/xss/sqli/ports)"
            echo -e "  ${GREEN}subdomains${NC}        Find subdomains"
            echo -e "  ${GREEN}urls${NC}              Collect URLs"
            echo -e "  ${GREEN}nuclei${NC}            Run nuclei"
            echo -e "  ${GREEN}secrets${NC}           Hunt for secrets"
            echo -e "  ${GREEN}results${NC}           Show results"
            echo -e "  ${GREEN}tools${NC}             Check tools"
            echo -e "  ${GREEN}exit${NC}              Quit"
            echo ""
            echo -e "${GRAY}Or just ask me naturally, like:${NC}"
            echo -e "  ${CYAN}??? 'find subdomains for example.com'${NC}"
            echo -e "  ${CYAN}??? 'scan example.com for vulnerabilities'${NC}"
            echo -e "  ${CYAN}??? 'test for xss'${NC}"
            ;;
        exit|quit)
            ai_say "Happy hunting! ????"
            exit 0
            ;;
        *)
            return 1
            ;;
    esac
    return 0
}

# Main function
main() {
    banner
    
    # Check Ollama
    info "Checking Ollama..."
    check_ollama
    log "Using model: ${CYAN}$MODEL${NC}"
    echo ""
    
    ai_say "Welcome! I'm your AI bug bounty assistant."
    ai_say "Tell me what you want to do, or type ${CYAN}help${NC} for commands."
    echo ""
    
    # Set target from argument
    [[ -n "$1" ]] && TARGET="$1" && log "Target: ${CYAN}$TARGET${NC}"
    
    while true; do
        # Prompt
        if [[ -n "$TARGET" ]]; then
            echo -ne "${PURPLE}hackstrike${NC}(${CYAN}$TARGET${NC})${GREEN}AI${NC}> "
        else
            echo -ne "${PURPLE}hackstrike${NC}${GREEN}AI${NC}> "
        fi
        
        read -r input
        [[ -z "$input" ]] && continue
        
        # Try to extract a command
        local cmd=$(extract_command "$input")
        
        if [[ -n "$cmd" ]]; then
            run_command "$cmd"
        else
            # Ask Ollama for help
            echo -e "${GRAY}Thinking...${NC}"
            local response=$(ask_ollama "$input")
            ai_say "$response"
            
            # Try to extract command from AI response
            local ai_cmd=$(extract_command "$response")
            if [[ -n "$ai_cmd" ]]; then
                echo ""
                read -p "$(echo -e "${YELLOW}Run: ${NC}${ai_cmd}${YELLOW}? [y/N] ${NC}")" confirm
                [[ "$confirm" =~ ^[Yy] ]] && run_command "$ai_cmd"
            fi
        fi
        echo ""
    done
}

main "$@"
