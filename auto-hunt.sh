#!/bin/bash

#====================================================================
#  AUTO-HUNT - Automated Bug Bounty Hunter
#  Continuously monitors and scans targets for new vulnerabilities
#====================================================================

set -o pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

log() { echo -e "${GREEN}[+]${NC} $1"; }
warn() { echo -e "${YELLOW}[!]${NC} $1"; }
error() { echo -e "${RED}[-]${NC} $1"; }

banner() {
    echo -e "${CYAN}"
    echo "  ?????????????????? ?????????   ???????????????????????????????????? ?????????????????????       ?????????  ??????????????????   ?????????????????????   ????????????????????????????????????"
    echo " ?????????????????????????????????   ???????????????????????????????????????????????????????????????      ?????????  ??????????????????   ????????????????????????  ????????????????????????????????????"
    echo " ?????????????????????????????????   ?????????   ?????????   ?????????   ????????????????????????????????????????????????????????????   ??????????????????????????? ?????????   ?????????   "
    echo " ?????????????????????????????????   ?????????   ?????????   ?????????   ????????????????????????????????????????????????????????????   ???????????????????????????????????????   ?????????   "
    echo " ?????????  ????????????????????????????????????   ?????????   ???????????????????????????      ?????????  ????????????????????????????????????????????? ??????????????????   ?????????   "
    echo " ?????????  ????????? ?????????????????????    ?????????    ?????????????????????       ?????????  ????????? ????????????????????? ?????????  ???????????????   ?????????   "
    echo -e "${NC}"
    echo -e "  ${GREEN}Continuous Bug Bounty Monitoring${NC}"
    echo ""
}

usage() {
    banner
    echo "Usage: $0 <targets-file> [options]"
    echo ""
    echo "Options:"
    echo "  -i, --interval N    Scan interval in hours (default: 24)"
    echo "  -n, --notify        Enable notifications (requires notify)"
    echo "  -h, --help          Show this help"
    echo ""
    echo "Examples:"
    echo "  $0 targets.txt                    # Hunt with default settings"
    echo "  $0 targets.txt -i 12              # Scan every 12 hours"
    echo "  $0 targets.txt -i 6 --notify      # Scan every 6 hours with notifications"
    echo ""
}

hunt() {
    local targets_file="$1"
    local interval="${2:-24}"
    local notify="${3:-false}"
    
    if [[ ! -f "$targets_file" ]]; then
        error "Targets file not found: $targets_file"
        exit 1
    fi
    
    banner
    log "Starting continuous hunt..."
    log "Targets file: $targets_file"
    log "Interval: ${interval}h"
    log "Notifications: $notify"
    echo ""
    
    while true; do
        log "Starting scan cycle at $(date)"
        
        while IFS= read -r target || [[ -n "$target" ]]; do
            [[ -z "$target" || "$target" =~ ^# ]] && continue
            
            log "Scanning: $target"
            "$SCRIPT_DIR/hackstrike" "$target" --full
            
            if [[ "$notify" == "true" ]] && command -v notify &>/dev/null; then
                notify -silent -bulk -data "$SCRIPT_DIR/results/${target}_*/vulns/nuclei.txt" 2>/dev/null
            fi
            
            sleep 60  # Brief pause between targets
        done < "$targets_file"
        
        log "Cycle complete. Sleeping for ${interval} hours..."
        sleep $((interval * 3600))
    done
}

# Parse arguments
TARGETS=""
INTERVAL=24
NOTIFY=false

while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help) usage; exit 0 ;;
        -i|--interval) INTERVAL="$2"; shift 2 ;;
        -n|--notify) NOTIFY=true; shift ;;
        -*) error "Unknown option: $1"; usage; exit 1 ;;
        *) TARGETS="$1"; shift ;;
    esac
done

if [[ -z "$TARGETS" ]]; then
    usage
    exit 1
fi

hunt "$TARGETS" "$INTERVAL" "$NOTIFY"
