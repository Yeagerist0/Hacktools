#!/bin/bash

#====================================================================
#  HACKSTRIKE - Automated Bug Bounty Scanner
#  Simple command-line version
#====================================================================

set -o pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m'

# Config
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
RESULTS_DIR="$SCRIPT_DIR/results"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
THREADS=50
RATE_LIMIT=150
TARGET=""
OUTPUT_DIR=""

log() { echo -e "${GREEN}[+]${NC} $1"; }
warn() { echo -e "${YELLOW}[!]${NC} $1"; }
error() { echo -e "${RED}[-]${NC} $1"; }
info() { echo -e "${BLUE}[*]${NC} $1"; }

banner() {
    echo -e "${RED}"
    cat << "EOF"
  _   _            _    ____  _        _ _        
 | | | | __ _  ___| | _/ ___|| |_ _ __(_) | _____ 
 | |_| |/ _` |/ __| |/ \___ \| __| '__| | |/ / _ \
 |  _  | (_| | (__|   < ___) | |_| |  | |   <  __/
 |_| |_|\__,_|\___|_|\_\____/ \__|_|  |_|_|\_\___|
EOF
    echo -e "${NC}"
    echo -e "${CYAN}  Automated Bug Bounty Scanner v1.0${NC}"
    echo ""
}

setup_output() {
    OUTPUT_DIR="$RESULTS_DIR/${TARGET}_${TIMESTAMP}"
    mkdir -p "$OUTPUT_DIR"/{recon,subdomains,urls,ports,vulns,web,exploits,secrets,params,reports}
    log "Output: $OUTPUT_DIR"
}

# Subdomain enumeration
do_subdomains() {
    log "Finding subdomains for $TARGET..."
    
    command -v subfinder &>/dev/null && {
        info "Running Subfinder..."
        subfinder -d "$TARGET" -all -silent -t $THREADS -o "$OUTPUT_DIR/subdomains/subfinder.txt" 2>/dev/null
    }
    
    command -v amass &>/dev/null && {
        info "Running Amass..."
        timeout 300 amass enum -passive -d "$TARGET" -o "$OUTPUT_DIR/subdomains/amass.txt" 2>/dev/null
    }
    
    cat "$OUTPUT_DIR/subdomains/"*.txt 2>/dev/null | sort -u > "$OUTPUT_DIR/subdomains/all.txt"
    log "Found $(wc -l < "$OUTPUT_DIR/subdomains/all.txt" 2>/dev/null || echo 0) subdomains"
}

# Live host detection
do_probe() {
    log "Probing live hosts..."
    
    if [[ -s "$OUTPUT_DIR/subdomains/all.txt" ]]; then
        httpx -l "$OUTPUT_DIR/subdomains/all.txt" -silent -t $THREADS \
            -status-code -title -tech-detect -o "$OUTPUT_DIR/recon/live_hosts.txt" 2>/dev/null
        cat "$OUTPUT_DIR/recon/live_hosts.txt" 2>/dev/null | awk '{print $1}' > "$OUTPUT_DIR/recon/live_urls.txt"
    else
        echo "https://$TARGET" > "$OUTPUT_DIR/recon/live_urls.txt"
        echo "http://$TARGET" >> "$OUTPUT_DIR/recon/live_urls.txt"
    fi
    
    log "Found $(wc -l < "$OUTPUT_DIR/recon/live_urls.txt" 2>/dev/null || echo 0) live hosts"
}

# URL collection
do_urls() {
    log "Collecting URLs..."
    
    command -v gau &>/dev/null && {
        echo "$TARGET" | gau --threads $THREADS > "$OUTPUT_DIR/urls/gau.txt" 2>/dev/null &
    }
    
    command -v waybackurls &>/dev/null && {
        echo "$TARGET" | waybackurls > "$OUTPUT_DIR/urls/wayback.txt" 2>/dev/null &
    }
    
    wait
    
    cat "$OUTPUT_DIR/urls/"*.txt 2>/dev/null | sort -u > "$OUTPUT_DIR/urls/all.txt"
    grep '=' "$OUTPUT_DIR/urls/all.txt" 2>/dev/null > "$OUTPUT_DIR/params/urls_with_params.txt"
    
    log "Found $(wc -l < "$OUTPUT_DIR/urls/all.txt" 2>/dev/null || echo 0) URLs"
}

# Port scanning
do_ports() {
    log "Scanning ports..."
    
    command -v naabu &>/dev/null && {
        naabu -host "$TARGET" -top-ports 1000 -silent -o "$OUTPUT_DIR/ports/naabu.txt" 2>/dev/null
    }
    
    nmap -sV -T4 --top-ports 100 "$TARGET" -oN "$OUTPUT_DIR/ports/nmap.txt" 2>/dev/null
    
    log "Port scan complete"
}

# Vulnerability scanning
do_vulns() {
    log "Scanning for vulnerabilities..."
    
    nuclei -ut 2>/dev/null
    
    if [[ -s "$OUTPUT_DIR/recon/live_urls.txt" ]]; then
        nuclei -l "$OUTPUT_DIR/recon/live_urls.txt" \
            -severity critical,high,medium \
            -c $THREADS -rl $RATE_LIMIT \
            -o "$OUTPUT_DIR/vulns/nuclei.txt" 2>/dev/null
    fi
    
    log "Found $(wc -l < "$OUTPUT_DIR/vulns/nuclei.txt" 2>/dev/null || echo 0) vulnerabilities"
}

# XSS testing
do_xss() {
    log "Testing for XSS..."
    
    command -v dalfox &>/dev/null || { warn "Dalfox not installed"; return; }
    
    if [[ -s "$OUTPUT_DIR/params/urls_with_params.txt" ]]; then
        head -100 "$OUTPUT_DIR/params/urls_with_params.txt" | \
        dalfox pipe --silence --no-color -w $THREADS -o "$OUTPUT_DIR/exploits/xss.txt" 2>/dev/null
    fi
    
    log "XSS: $(wc -l < "$OUTPUT_DIR/exploits/xss.txt" 2>/dev/null || echo 0) findings"
}

# SQLi testing
do_sqli() {
    log "Testing for SQL injection..."
    
    command -v sqlmap &>/dev/null || { warn "SQLMap not installed"; return; }
    
    if [[ -s "$OUTPUT_DIR/params/urls_with_params.txt" ]]; then
        head -10 "$OUTPUT_DIR/params/urls_with_params.txt" | while read url; do
            sqlmap -u "$url" --batch --random-agent --level=1 --risk=1 \
                --output-dir="$OUTPUT_DIR/exploits/sqlmap/" 2>/dev/null | \
                grep -E '(is vulnerable|injectable)' >> "$OUTPUT_DIR/exploits/sqli.txt"
        done
    fi
    
    log "SQLi: $(wc -l < "$OUTPUT_DIR/exploits/sqli.txt" 2>/dev/null || echo 0) findings"
}

# Secrets detection
do_secrets() {
    log "Hunting for secrets..."
    
    # Check .git
    curl -sk --max-time 5 "https://$TARGET/.git/HEAD" 2>/dev/null | grep -q 'ref:' && \
        echo "https://$TARGET/.git/" >> "$OUTPUT_DIR/secrets/exposed.txt"
    
    # Check .env
    curl -sk --max-time 5 "https://$TARGET/.env" 2>/dev/null | grep -qiE '(DB_|APP_|API_|SECRET)' && \
        echo "https://$TARGET/.env" >> "$OUTPUT_DIR/secrets/exposed.txt"
    
    log "Secrets: $(wc -l < "$OUTPUT_DIR/secrets/exposed.txt" 2>/dev/null || echo 0) findings"
}

# Generate report
do_report() {
    log "Generating report..."
    
    cat << EOF > "$OUTPUT_DIR/reports/report.md"
# HackStrike Scan Report

## Target: $TARGET
**Date:** $(date)

## Summary
| Category | Count |
|----------|-------|
| Subdomains | $(wc -l < "$OUTPUT_DIR/subdomains/all.txt" 2>/dev/null || echo 0) |
| Live Hosts | $(wc -l < "$OUTPUT_DIR/recon/live_urls.txt" 2>/dev/null || echo 0) |
| URLs | $(wc -l < "$OUTPUT_DIR/urls/all.txt" 2>/dev/null || echo 0) |
| Vulnerabilities | $(wc -l < "$OUTPUT_DIR/vulns/nuclei.txt" 2>/dev/null || echo 0) |
| XSS | $(wc -l < "$OUTPUT_DIR/exploits/xss.txt" 2>/dev/null || echo 0) |
| SQLi | $(wc -l < "$OUTPUT_DIR/exploits/sqli.txt" 2>/dev/null || echo 0) |
| Secrets | $(wc -l < "$OUTPUT_DIR/secrets/exposed.txt" 2>/dev/null || echo 0) |

## Results
\`$OUTPUT_DIR\`
EOF
    
    log "Report: $OUTPUT_DIR/reports/report.md"
}

# Full scan
full_scan() {
    do_subdomains
    do_probe
    do_urls
    do_ports
    do_vulns
    do_xss
    do_sqli
    do_secrets
    do_report
    
    echo ""
    echo -e "${GREEN}═══════════════════════════════════════════════════════════════${NC}"
    echo -e "${WHITE}                      SCAN COMPLETE${NC}"
    echo -e "${GREEN}═══════════════════════════════════════════════════════════════${NC}"
    echo -e "  Target:          ${CYAN}$TARGET${NC}"
    echo -e "  Subdomains:      $(wc -l < "$OUTPUT_DIR/subdomains/all.txt" 2>/dev/null || echo 0)"
    echo -e "  Live Hosts:      $(wc -l < "$OUTPUT_DIR/recon/live_urls.txt" 2>/dev/null || echo 0)"
    echo -e "  URLs:            $(wc -l < "$OUTPUT_DIR/urls/all.txt" 2>/dev/null || echo 0)"
    echo -e "  ${RED}Vulnerabilities:${NC} $(wc -l < "$OUTPUT_DIR/vulns/nuclei.txt" 2>/dev/null || echo 0)"
    echo -e "  ${RED}XSS:${NC}             $(wc -l < "$OUTPUT_DIR/exploits/xss.txt" 2>/dev/null || echo 0)"
    echo -e "  ${RED}SQLi:${NC}            $(wc -l < "$OUTPUT_DIR/exploits/sqli.txt" 2>/dev/null || echo 0)"
    echo -e "  ${RED}Secrets:${NC}         $(wc -l < "$OUTPUT_DIR/secrets/exposed.txt" 2>/dev/null || echo 0)"
    echo -e "${GREEN}═══════════════════════════════════════════════════════════════${NC}"
    echo -e "  Report: ${BLUE}$OUTPUT_DIR/reports/report.md${NC}"
    echo ""
}

usage() {
    banner
    echo "Usage: $0 <target> [options]"
    echo ""
    echo "Options:"
    echo "  -f, --full        Full scan (default)"
    echo "  -r, --recon       Recon only (subdomains + URLs)"
    echo "  -v, --vulns       Vulnerability scan only"
    echo "  -x, --xss         XSS testing only"
    echo "  -s, --sqli        SQLi testing only"
    echo "  -p, --ports       Port scan only"
    echo "  -t, --threads N   Number of threads (default: 50)"
    echo "  -h, --help        Show this help"
    echo ""
    echo "Examples:"
    echo "  $0 example.com              # Full scan"
    echo "  $0 example.com --recon      # Recon only"
    echo "  $0 example.com --vulns      # Vuln scan only"
    echo "  $0 example.com -t 100       # Full scan with 100 threads"
    echo ""
}

# Main
main() {
    local mode="full"
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            -h|--help) usage; exit 0 ;;
            -f|--full) mode="full"; shift ;;
            -r|--recon) mode="recon"; shift ;;
            -v|--vulns) mode="vulns"; shift ;;
            -x|--xss) mode="xss"; shift ;;
            -s|--sqli) mode="sqli"; shift ;;
            -p|--ports) mode="ports"; shift ;;
            -t|--threads) THREADS="$2"; shift 2 ;;
            -*) error "Unknown option: $1"; usage; exit 1 ;;
            *) TARGET="$1"; shift ;;
        esac
    done
    
    if [[ -z "$TARGET" ]]; then
        usage
        exit 1
    fi
    
    # Clean target
    TARGET=$(echo "$TARGET" | sed 's|https\?://||' | sed 's|/.*||')
    
    banner
    log "Target: $TARGET"
    log "Mode: $mode"
    log "Threads: $THREADS"
    echo ""
    
    mkdir -p "$RESULTS_DIR"
    setup_output
    
    case $mode in
        full) full_scan ;;
        recon) do_subdomains; do_probe; do_urls; do_report ;;
        vulns) do_subdomains; do_probe; do_vulns; do_report ;;
        xss) do_subdomains; do_probe; do_urls; do_xss; do_report ;;
        sqli) do_subdomains; do_probe; do_urls; do_sqli; do_report ;;
        ports) do_ports; do_report ;;
    esac
}

main "$@"
